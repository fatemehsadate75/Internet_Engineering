<?php
 if($this->licenseCheck()['status'] == 'true') { if (!class_exists('jDateTime')) { include_once('jDateTime.php'); } $licenseexpiretime = jDateTime::date('Y/m/d H:i', $this->license['expiretime'], null, true,null); $oosFilter_product = $oosFilter_product_attribute = $oosFilter_phones = $oosFilter_shop = $oosOrderby = $oosOrderway = null; $output .= '<ul class="nav nav-tabs"><li class="active"><a href="#oosreport" data-toggle="tab">'.$this->l('Out of Stock Subscribers Report').'</a></li><li><a href="#oossettings" data-toggle="tab">تنظیمات  خبرنامه کالاهای ناموجود</a></li></ul>'; $output .= '<div class="tab-content">'; if(Tools::getValue('submitFilteroos') == 1) { if(Tools::getValue('page')) $page = Tools::getValue('page'); if(Tools::getValue('selected_pagination')) $pagination = Tools::getValue('selected_pagination'); if(Tools::getValue('oosFilter_id_product')) $oosFilter_product = Tools::getValue('oosFilter_id_product'); if(Tools::getValue('oosFilter_id_product_attribute')) $oosFilter_product_attribute = Tools::getValue('oosFilter_id_product_attribute'); if(Tools::getValue('oosFilter_id_shop')) $oosFilter_shop = Tools::getValue('oosFilter_id_shop'); if(Tools::getValue('oosFilter_phones')) $oosFilter_phones = Tools::getValue('oosFilter_phones'); }else{ unset($_POST['oosFilter_id_product'],$_POST['oosFilter_id_product_attribute'],$_POST['oosFilter_id_shop'],$_POST['oosFilter_phones']); } if(isset($_GET['oosOrderby']) && isset($_GET['oosOrderway']) ) { if(Tools::getValue('oosOrderby')) $oosOrderby = Tools::getValue('oosOrderby'); if(Tools::getValue('oosOrderway')) $oosOrderway = Tools::getValue('oosOrderway'); } $ooss = $this->getOOS(0, 'all', null,$oosFilter_phones,null, null,null, null, $oosOrderby, $oosOrderway); $oosrows = array(); $products = array(); $shops = array(); foreach ($ooss as $oos) { $product = new Product((int) $oos['id_product'],false,$oos['id_lang']); $token = Tools::getAdminTokenLite('AdminProducts'); $request_scheme = Tools::getShopProtocol(); $hostlink = $request_scheme . $_SERVER['SERVER_NAME'] . $_SERVER['PHP_SELF']; $pruductediturl = "?controller=AdminProducts&id_product=" . $oos['id_product']."&updateproduct"; $productUrlLink = $hostlink . $pruductediturl ."&token=" . $token; $product_name = $product->name; $product_quantity = StockAvailable::getQuantityAvailableByProduct($oos['id_product']); $attributes = $product->getAttributesGroups((int)$oos['id_lang']); $attribute_nameArray = array(); foreach ($attributes as $attribute) { if(isset($attribute['id_product_attribute']) && $attribute['id_product_attribute'] == $oos['id_product_attribute']){ $attribute_nameArray[] = $attribute['group_name'] . ': ' . $attribute['attribute_name']; $attribute_nameArray[] = StockAvailable::getStockAvailableIdByProductId($oos['id_product'], $attribute['id_product_attribute']); $product_quantity = StockAvailable::getQuantityAvailableByProduct($oos['id_product'], $attribute['id_product_attribute']); } } $attribute_name = implode(' - ', $attribute_nameArray); $shop = Shop::getShop($oos['id_shop']); $shop_name = $shop['name']; $action = '<a class="ajaxAction" data-action="phonelist" title="'.$this->l('Phone List').'" data-toggle="modal" data-target="#rangineModal" data-product="'.$oos['id_product'].'" data-product-attribute="'.$oos['id_product_attribute'].'" data-id-shop="'.$oos['id_shop'].'"><i class="icon-list-alt"></i></a>
	<a class="clearGroup" data-action="clear" title="'.$this->l('Remove Subscribers').'" data-product="'.$oos['id_product'].'" data-product-attribute="'.$oos['id_product_attribute'].'" data-id-shop="'.$oos['id_shop'].'"><i class="icon-eraser"></i></a>	
	<a class="sendoossms" data-action="oossendsms" title="'.$this->l('Send a SMS').'" data-product="'.$oos['id_product'].'" data-product-attribute="'.$oos['id_product_attribute'].'" data-id-shop="'.$oos['id_shop'].'" data-text="<p>ارسال پیامک به کاربرانی که برای موجود شدن محصول «'.$product_name.'» با ترکیب «'.$attribute_name.'» درخواست ارسال پیامک کرده اند.</p></p><textarea id=SENDONETEXT class=\'textarea-autosize\' style=\'overflow: hidden; overflow-wrap: break-word; resize: none; height: 65px;\'></textarea><p class=\'help-block\'>متن پیامک را تایپ نمایید. توجه داشته باشید که صفحه اول پیامک فارسی 70 کاراکتر و صفحه های دیگر 64 کاراکتر حساب می شود.</p>"><i class="icon-rocket"></i></a>'; if($oosFilter_product !== null && strpos($oos['id_product'].' - '.$product_name,$oosFilter_product) === false) continue; if($oosFilter_product_attribute !== null && strpos($attribute_name,$oosFilter_product_attribute) === false) continue; if($oosFilter_shop !== null && strpos($shop_name,$oosFilter_shop) === false) continue; $oosrows[] = array( 'id_product' => '<a href="'.$productUrlLink.'" target="_BLANK">'.$oos['id_product'].' - '.$product_name.'</a>', 'id_product_attribute' => $attribute_name, 'product_quantity' => $product_quantity, 'id_shop' => $shop_name, 'phones' => $oos['phones'], 'action' => $action, ); $products[$oos['id_product']] = $oos['id_product']; $phones[$oos['phones']] = $oos['phones']; $shops[$shop_name] = $shop_name; } asort($products); asort($shops); $fields_list = array( 'id_product' => array( 'title' => $this->l('Product'), 'search' => true, 'class' => 'id_product', ), 'id_product_attribute' => array( 'title' => $this->l('Product Attribute'), 'search' => true, 'class' => 'product_attribute', 'order_key' => 'id_product_attribute', ), 'id_shop' => array( 'title' => $this->l('Shop'), 'search' => true, 'class' => 'shop', ), 'product_quantity' => array( 'title' => $this->l('Quantity'), 'search' => true, 'class' => 'product_quantity', 'order_key' => 'product_quantity', ), 'phones' => array( 'title' => $this->l('Subscribers'), 'search' => true, 'class' => 'phones', ), 'action' => array( 'title' => $this->l('ACTIONS'), 'search' => false, 'orderby' => false, 'class' => 'ajaxaction', ) ); if (!Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE')) unset($fields_list['shop_name']); $helper_list = New HelperList(); $helper_list->module = $this; $helper_list->title = '<i class="icon-list"></i>'.$this->l('Out of Stock Subscribers Report'); $helper_list->shopLinkType = ''; $helper_list->no_link = true; $helper_list->show_toolbar = false; $helper_list->simple_header = false; $helper_list->identifier = 'id_product1'; $helper_list->table = 'oos'; $helper_list->currentIndex = $this->context->link->getAdminLink('AdminModules', false).'&configure='.$this->name.'&subpage=oosSubscribers'; $helper_list->token = Tools::getAdminTokenLite('AdminModules'); $this->_helperlist = $helper_list; $helper_list->listTotal = count($oosrows); $page = ($page = Tools::getValue('submitFilter'.$helper_list->table)) ? $page : 1; $pagination = ($pagination = Tools::getValue($helper_list->table.'_pagination')) ? $pagination : 50; if(count($oosrows) > $pagination) $oosrows = array_slice($oosrows, $pagination * ($page - 1), $pagination); $output .= '<div id="oosreport" class="tab-pane active">'; $output .= $helper_list->generateList($oosrows, $fields_list).'</div>
<script>
	$("table.oos .id_product, table.oos .ajaxaction").each(function(){
		$(this).html($(this).text())
	});
	$("td.ajaxaction").before("<td></td>");
	$("th.ajaxaction").before("<th></th>");
	$(\'[name="oosFilter_id_product"]\').attr("placeholder","جستجوی شماره یا نام محصول");
	$(\'[name="oosFilter_id_product_attribute"]\').attr("placeholder","جستجوی ویژگی محصول");
	$(\'[name="oosFilter_id_shop"]\').attr("placeholder","جستجوی نام فروشگاه");
	$(\'[name="oosFilter_phones"]\').attr("placeholder","جستجوی شماره همراه");
</script>'; $fieldsValues = $this->getConfigFieldsValues(); $fieldsValues['OOSIGNOREATTRCAT'] = explode(',', $fieldsValues['OOSIGNOREATTRCAT']); $fields_form_oos = array( 'form' => array( 'legend' => array( 'title' => $this->l('Out of Stock Settings').' - <span class="license-expiretime">لایسنس این بخش تا این تاریخ معتبر است: '.$licenseexpiretime.'</span>', 'icon' => 'icon-cogs' ), 'input' => array( array( 'type' => 'switch', 'label' => $this->l('Alerts when pruducts goes out of stock:'), 'class' => 'fixed-width-md', 'name' => 'OUTOFSTOCK', 'desc' => $this->l('Send to Admin'), 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'text', 'label' => $this->l('Threshold:'), 'name' => 'OUTOFSTOCKTHRESHOLD', 'class' => 'fixed-width-md', 'desc' => $this->l('Quantity for which a product is considered out of stock.'), ), array( 'type' => 'switch', 'label' => $this->l('Product availability:'), 'class' => 'fixed-width-md', 'name' => 'BACKTOSTOCK', 'desc' => $this->l('Send to Customer'), 'hint' => $this->l('Gives the customer the option of receiving a sms notification when an out-of-stock product is available again.'), 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('Sent Back to Stock Automaticly:'), 'class' => 'fixed-width-md', 'name' => 'OOSAUTO', 'desc' => $this->l('Send to customer. If set to False you should go to Out Of Stock tab and send Sms manual.'), 'hint' => $this->l('Send back to stock SMS alerts immediately after a product goes back to stock. The admin recieved a sms in both cases.'), 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('Send sent sms summary:'), 'class' => 'fixed-width-md', 'name' => 'OOSSUMADMIN', 'desc' => $this->l('Send to admin. If set to true the administrator recive a sms that contains how many messages have sent by back to stock action Or how many users are waiting back to stock sms depend on what choose in previews option'), 'hint' => $this->l('If you choose that back-to-stock messages send automaticly you will recive a summary sms after sending message to all recivers. Otherwise you will recive a message contains how many people are want that product.'), 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'text', 'label' => $this->l('Out of Stock Sender:'), 'name' => 'OOSSERNDER', 'class' => 'fixed-width-lg', 'desc' => $this->l('ex: 5000125475.'), ), array( 'type' => 'text', 'label' => $this->l('Product Short Url Pattern:'), 'name' => 'SHORTPRODUCTKEY', 'class' => 'fixed-width-lg ltr', 'desc' => $this->l('Choose Product short url first argument; for example, if you type "rsp" your short invoice link will be http://yoursiteurl/rsp/12 . Attention: If you change this all generaterd short links will redirect to 404 page.'), ), array( 'type' => 'text', 'label' => $this->l('Notify me button Text:'), 'name' => 'OOSBUTTONTEXT', 'class' => 'fixed-width-lg', 'desc' => $this->l('Type the text that you want to show on Notify me button'), ), array( 'type' => 'text', 'label' => $this->l('Put Notify me button after this element:'), 'name' => 'OOSBUTTONPOSITION', 'class' => 'fixed-width-lg', 'desc' => $this->l('If the Notify Me button is in misplaced position you can type here the jquery selector of element that you want to put the button aftr it. like: .product-minimal-quantity'), ), array( 'type' => 'text', 'label' => $this->l('Notify me button wrapper selector:'), 'name' => 'OOSBUTTONWRAPPER', 'class' => 'fixed-width-lg', 'desc' => $this->l('If you type any jquery selector in previews field, type the notify button wrapper element selector here. like : #oosHook or .product-out-of-stock'), ), array( 'type' => 'categories', 'tree' => array( 'id' => 'oos_categuries', 'use_search' => true, 'use_checkbox' => true, 'selected_categories' => $fieldsValues['OOSIGNOREATTRCAT'], ), 'label' => 'شاخه هایی که حساسیت به ترکیب ندارند:', 'name' => 'OOSIGNOREATTRCAT', 'class' => 'fixed-width-lg', 'desc' => 'شاخه هایی که حساسیت به ترکیب نداشته باشند، هنگامی که هر ترکیب از آن شاخه موجود شد به کسانی که ترکیبات دیگری از آن محصول را درخواست داده باشند پیامک اتوماتیک موجودی کالا ارسال خواهد شد.', ), ), 'submit' => array( 'title' => $this->l('Update Settings'), 'name' => 'oossettings', ) ) ); $helper = new HelperForm(); $helper->module = $this; $helper->name_controller = $this->name; $helper->token = Tools::getAdminTokenLite('AdminModules'); $helper->show_toolbar = false; $helper->toolbar_scroll = false; $lang = new Language((int)Configuration::get('PS_LANG_DEFAULT')); $helper->default_form_language = $lang->id; $allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG'); $helper->allow_employee_form_lang = $allow_employee_form_lang ? $allow_employee_form_lang : 0; $this->fields_form = array(); $helper->submit_action = $this->name; $helper->currentIndex = $this->context->link->getAdminLink('AdminModules', false). '&configure='.$this->name.'&tab_module='.$this->tab.'&module_name='.$this->name; $helper->tpl_vars = array( 'fields_value' => $fieldsValues, 'languages' => $this->context->controller->getLanguages(), 'id_language' => $this->context->language->id ); $output .= '<div id="oossettings" class="tab-pane">'.$helper->generateForm(array($fields_form_oos)).'</div>'; $output .= '</div><!--Tabs Contents-->'; $output .= '</div>
	<div class="modal fade" id="rangineModal">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close modal-clear" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
			<h4 class="modal-title"></h4>
		  </div>
		  <div class="modal-body">
			<center><span class="loader"></span></center>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default modal-clear" data-dismiss="modal">'.$this->l('Close').'</button>
			
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->'; }else{ $output .= $this->licenseForm(); }