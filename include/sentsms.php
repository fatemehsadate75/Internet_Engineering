<?php
 if (!class_exists('jDateTime')) { include_once('jDateTime.php'); } $output = ''; $sentsmsFilter_id = $sentsmsFilter_customer = $sentsmsFilter_id_order = $sentsmsFilter_phone = $sentsmsFilter_position = $sentsmsFilter_status = $sentsmsFilter_bulk = $sentsmsFilter_delivery = $sentsmsFilter_shop = $sentsmsFilter_description = $sentsmsOrderby = $sentsmsOrderway = null; if(Tools::isSubmit('submitBulksendagainsentsms') && is_array(Tools::getValue('sentsmsBox')) && count(Tools::getValue('sentsmsBox')) > 0){ $bulkSendSmsResult = "<div class='alert alert-success'><button type='button' class='close' data-dismiss='alert'>×</button>نتیجه ارسال مجدد پیامک های انتخاب شده:<ul>"; foreach (Tools::getValue('sentsmsBox') as $id_sms) { $log = $this->getLogs(0,1, null, null,null, null, null, null, null, $id_sms); $bulkSendSmsResult .= "<li>پیامک شماره '$id_sms' : " . $this->sendOne($log[0]['description'], $log[0]['phone'], $log[0]['customer'], $log[0]['id_order'], $log[0]['position'])."</li>"; } $bulkSendSmsResult .= "</ul></div>"; $this->context->cookie->redirect_success_message = $bulkSendSmsResult; $submited = 'sentsms'; Tools::redirect($this->moduleSubpageUrl($submited)); } if(Tools::isSubmit('submitBulkdeletesentsms') && is_array(Tools::getValue('sentsmsBox')) && count(Tools::getValue('sentsmsBox')) > 0){ $bulkDeleteSmsResult = "نتیجه حذف پیامک های انتخاب شده:<ul>"; foreach (Tools::getValue('sentsmsBox') as $id_sms) { if($this->deleteLog($id_sms) == 1) $deleteResult = 'حذف شد.'; else $deleteResult = 'مشکلی در حذف روی داد.'; $bulkDeleteSmsResult .= "<li>پیامک شماره '$id_sms' : " . $deleteResult."</li>"; } $bulkDeleteSmsResult .= "</ul>"; unset($_POST['deletesmsBox']); $this->context->cookie->redirect_success_message = $bulkDeleteSmsResult; $submited = 'sentsms'; Tools::redirect($this->moduleSubpageUrl($submited)); } if(Tools::isSubmit('deletesentsms') && Tools::isSubmit('id')){ if($this->deleteLog(Tools::getValue('id')) == 1) $deleteResult = 'حذف شد.'; else $deleteResult = 'مشکلی در حذف روی داد.'; $DeleteSmsResult = "نتیجه حذف پیامک شماره ".Tools::getValue('id').":".$deleteResult; unset($_POST['deletesentsms']); $this->context->cookie->redirect_success_message = $DeleteSmsResult; $submited = 'sentsms'; Tools::redirect($this->moduleSubpageUrl($submited)); } $output .= '<ul class="nav nav-tabs"><li class="active"><a href="#smsreport" data-toggle="tab">گزارش پیامک های ارسالی</a></li><li><a href="#smsreportsettings" data-toggle="tab">تنظیمات گزارش پیامک ها</a></li></ul>'; $output .= '<div class="tab-content">'; if(Tools::getValue('submitFiltersentsms') == 1) { if(Tools::getValue('page')) $page = Tools::getValue('page'); if(Tools::getValue('selected_pagination')) $pagination = Tools::getValue('selected_pagination'); if(Tools::getValue('sentsmsFilter_customer')) $sentsmsFilter_customer = Tools::getValue('sentsmsFilter_customer'); if(Tools::getValue('sentsmsFilter_id_order')) $sentsmsFilter_id_order = Tools::getValue('sentsmsFilter_id_order'); if(Tools::getValue('sentsmsFilter_id')) $sentsmsFilter_id = Tools::getValue('sentsmsFilter_id'); if(Tools::getValue('sentsmsFilter_phone')) $sentsmsFilter_phone = Tools::getValue('sentsmsFilter_phone'); if(Tools::getValue('sentsmsFilter_position')) $sentsmsFilter_position = Tools::getValue('sentsmsFilter_position'); if(Tools::getValue('sentsmsFilter_status')) $sentsmsFilter_status = Tools::getValue('sentsmsFilter_status'); if(Tools::getValue('sentsmsFilter_bulk')) $sentsmsFilter_bulk = Tools::getValue('sentsmsFilter_bulk'); if(Tools::getValue('sentsmsFilter_delivery')) $sentsmsFilter_delivery = Tools::getValue('sentsmsFilter_delivery'); if(Tools::getValue('sentsmsFilter_shop')) $sentsmsFilter_shop = Tools::getValue('sentsmsFilter_shop'); if(Tools::getValue('sentsmsFilter_description')) $sentsmsFilter_description = Tools::getValue('sentsmsFilter_description'); }else{ unset($_POST['sentsmsFilter_id'],$_POST['sentsmsFilter_customer'],$_POST['sentsmsFilter_id_order'],$_POST['sentsmsFilter_phone'],$_POST['sentsmsFilter_position'],$_POST['local_sentsmsFilter_time'],$_POST['sentsmsFilter_time'],$_POST['sentsmsFilter_status'],$_POST['sentsmsFilter_bulk'],$_POST['sentsmsFilter_delivery'],$_POST['sentsmsFilter_shop'],$_POST['sentsmsFilter_description'],$_POST['sentsmsOrderby'],$_POST['sentsmsOrderway']); } if(isset($_GET['sentsmsOrderby']) && isset($_GET['sentsmsOrderway']) ) { if(Tools::getValue('sentsmsOrderby')) $sentsmsOrderby = Tools::getValue('sentsmsOrderby'); if(Tools::getValue('sentsmsOrderway')) $sentsmsOrderway = Tools::getValue('sentsmsOrderway'); } if(Tools::getValue('sentsms_pagination')) $sentsms_pagination = Tools::getValue('sentsms_pagination'); else $sentsms_pagination = 50; if(Tools::getValue('submitFiltersentsms')) $sentsms_page = Tools::getValue('submitFiltersentsms'); else $sentsms_page = 1; $logs = $this->getLogs($sentsms_page, $sentsms_pagination, $sentsmsFilter_bulk, $sentsmsFilter_phone, $sentsmsFilter_customer, $sentsmsFilter_id_order, $sentsmsFilter_position, $sentsmsFilter_shop, $sentsmsFilter_status, $sentsmsFilter_id, $sentsmsFilter_description, $sentsmsOrderby, $sentsmsOrderway); $logscount = $this->getLogsCount(0, 'all', $sentsmsFilter_bulk, $sentsmsFilter_phone, $sentsmsFilter_customer, $sentsmsFilter_id_order, $sentsmsFilter_position, $sentsmsFilter_shop, $sentsmsFilter_status, $sentsmsFilter_id, $sentsmsFilter_description, $sentsmsOrderby, $sentsmsOrderway); $sentsms = array(); $statuses = array(); $deliveries = array(); $positions = array(); $shops = array(); $optionalFields = array( 'ShowSentSMScustomer'=>'customer', 'ShowSentSMSorder'=>'id_order', 'ShowSentSMSposition'=>'position', 'ShowSentSMStime'=>'time', 'ShowSentSMSstatus'=>'status', 'ShowSentSMSbulk'=>'bulk', 'ShowSentSMSshop'=>'shop', 'ShowSentSMSduration'=>'duration', ); foreach($optionalFields as $field => $id){ if(Configuration::get($this->prefix . $field) == 0) { $optionalFields[$field] = 0; }else{ $optionalFields[$field] = 1; } } $order = 0; foreach ($logs as $i => $log) { $shop = Shop::getShop($log['shop']); $shop_name = $shop['name']; if($log['type'] == 'bysample' && $i < 200) $log['description'] = $this->patternSmsHumanity($log['description']); if(strlen($log['phone']) > 40){ $phoneslist= '<div id="phonelist-'.$log['id_ranginesmspresta'].'" class="hiddenphonelist"><span class="close" onclick="$(\'#phonelist-'.$log['id_ranginesmspresta'].'\').removeClass(\'show\');">X</span>'.$log['phone'].'</div><span onclick="$(\'#phonelist-'.$log['id_ranginesmspresta'].'\').addClass(\'show\');" title="جهت مشاهده شماره ها کلیک کنید">بیش از 3 شماره</span>'; }else{ $phoneslist = $log['phone']; } $order++; $sentsms[$order] = array( 'id' => $log['id_ranginesmspresta'], 'customer' => $log['customer'], 'id_order' => $log['id_order'], 'phone' => $phoneslist, 'position' => $this->l($log['position']), 'time' => "<span title='".date("Y/m/d H:i:s",$log['timestamp'])."'>".jDateTime::date('Y/m/d H:i:s', $log['timestamp'], null, true,null)."</span>", 'status' => $this->l($log['status']), 'bulk' => $log['bulk'], 'delivery' => $this->deliveryStatus($log['delivery'],$log['bulk'],$log['type']), 'shop' => $shop_name, 'description' => str_replace('~','<br>',$log['description']), 'duration' => number_format((float)$log['duration'], 3, '.', ''), ); if($optionalFields['ShowSentSMScustomer'] == 0) unset($sentsms[$order]['customer']); if($optionalFields['ShowSentSMSorder'] == 0) unset($sentsms[$order]['id_order']); if($optionalFields['ShowSentSMSposition'] == 0) unset($sentsms[$order]['position']); if($optionalFields['ShowSentSMStime'] == 0) unset($sentsms[$order]['time']); if($optionalFields['ShowSentSMSstatus'] == 0) unset($sentsms[$order]['status']); if($optionalFields['ShowSentSMSbulk'] == 0) unset($sentsms[$order]['bulk']); if($optionalFields['ShowSentSMSshop'] == 0) unset($sentsms[$order]['shop']); if($optionalFields['ShowSentSMSduration'] == 0) unset($sentsms[$order]['duration']); $statuses[$log['status']] = $log['status']; if($log['delivery']) $deliveries[$log['delivery']] = $this->deliveryStatusTranslate($log['delivery']); $positions[$log['position']] = $log['position']; $shops[$shop_name] = $shop_name; } asort($statuses); asort($deliveries); asort($positions); asort($shops); $fields_list = array( 'id' => array( 'title' => $this->l('ID'), 'search' => true, ), 'customer' => array( 'title' => $this->l('CUSTOMER'), 'search' => true, 'class' => 'customer', ), 'id_order' => array( 'title' => $this->l('ORDER'), 'search' => true, 'class' => 'id_order', ), 'phone' => array( 'title' => $this->l('PHONE'), 'search' => true, 'class' => 'phone', ), 'position' => array( 'title' => $this->l('POSITION'), 'search' => true, 'type' => 'select', 'list' => $positions, 'filter_key' => 'position', 'order_key' => 'position', 'class' => 'position', ), 'time' => array( 'title' => $this->l('TIME'), 'type' => 'text', 'search' => false, 'class' => 'smstime', ), 'status' => array( 'title' => $this->l('STATUS'), 'search' => true, 'type' => 'select', 'list' => $statuses, 'filter_key' => 'status', 'order_key' => 'status' ), 'bulk' => array( 'title' => $this->l('BULK'), 'search' => true, 'class' => 'bulk', ), 'delivery' => array( 'title' => $this->l('DELIVERY'), 'search' => true, 'type' => 'select', 'list' => $deliveries, 'filter_key' => 'delivery', 'order_key' => 'delivery', 'class' => 'delivery', ), 'shop' => array( 'title' => $this->l('SHOP'), 'search' => true, 'type' => 'select', 'list' => $shops, 'filter_key' => 'shop', 'order_key' => 'shop', 'class' => 'idshop' ), 'description' => array( 'title' => $this->l('DESCRIPTION'), 'search' => true, 'class' => 'smstext' ), 'duration' => array( 'title' => $this->l('Duration'), 'search' => false, 'class' => 'duration' ), 'actions' => array( 'title' => $this->l('ACTIONS'), 'search' => false, 'orderby' => false, ) ); if($optionalFields['ShowSentSMScustomer'] == 0) unset($fields_list['customer']); if($optionalFields['ShowSentSMSorder'] == 0) unset($fields_list['id_order']); if($optionalFields['ShowSentSMSposition'] == 0) unset($fields_list['position']); if($optionalFields['ShowSentSMStime'] == 0) unset($fields_list['time']); if($optionalFields['ShowSentSMSstatus'] == 0) unset($fields_list['status']); if($optionalFields['ShowSentSMSbulk'] == 0) unset($fields_list['bulk']); if($optionalFields['ShowSentSMSshop'] == 0) unset($fields_list['shop']); if($optionalFields['ShowSentSMSduration'] == 0) unset($fields_list['duration']); if (!Configuration::get('PS_MULTISHOP_FEATURE_ACTIVE')) unset($fields_list['shop_name']); $helper_list = New HelperList(); $helper_list->module = $this; $helper_list->title = '<i class="icon-list"></i>'.$this->l('Sent SMS').'<ul id="sentsmsactions" class="pull-right"><li class="dropdown"><a class="dropdown-toggle" href="javascript:void(0)" id="showactions" data-toggle="dropdown">'.$this->l('Actions').' <i class="icon-caret-down"></i></a><ul class="dropdown-menu actionlist"><li><a href="javascript:void(0)" id="clearAllQueue">'.$this->l('Clear All Queued SMS').'</a></li></ul></li></ul>'; $helper_list->shopLinkType = ''; $helper_list->no_link = true; $helper_list->show_toolbar = false; $helper_list->simple_header = false; $helper_list->identifier = 'id'; $helper_list->table = 'sentsms'; $helper_list->currentIndex = $this->context->link->getAdminLink('AdminModules', false).'&configure='.$this->name.'&subpage=sentsms'; $helper_list->token = Tools::getAdminTokenLite('AdminModules'); $helper_list->actions = array('sendagain','delete'); $helper_list->bulk_actions = array( 'sendagain' => array( 'text' => $this->l('Send selected SMS again'), 'confirm' => $this->l('Send selected messages?'), 'icon' => 'icon-rocket' ), 'delete' => array( 'text' => $this->l('Delete selected SMS log'), 'confirm' => $this->l('Are you sure you want to delete log(s)?'), 'icon' => 'icon-trash' ), ); $this->_helperlist = $helper_list; $helper_list->listTotal = $logscount[0][cnt]; $page = ($page = Tools::getValue('submitFilter'.$helper_list->table)) ? $page : 1; $pagination = ($pagination = Tools::getValue($helper_list->table.'_pagination')) ? $pagination : 20; $output .= '<div id="smsreport" class="tab-pane active">'; $output .= $helper_list->generateList($sentsms, $fields_list).'</div>
<script>
	$("table.sentsms .smstime, table.sentsms .delivery, table.sentsms .phone, table.sentsms .smstext").each(function(){
		$(this).html($(this).text())
	});
</script>'; $fields_form = array( 'form' => array( 'legend' => array( 'title' => '<b data-toggle="collapse" data-target="#collapsed-target-teaching" style="cursor: pointer;" class="collapsed">تنظیمات گزارش پیامک ها</b>', 'icon' => 'icon-cogs', ), 'input' => array( array( 'type' => 'html', 'label' => $this->l('Active fields in report:'), 'name' => 'در این صفحه ستون هایی که مایلید در صفحه گزارش پیامک های ارسالی نمایش داده شود را فعال نمایید. اگر جدول گزارشات ارسالی در عرض صفحه شما جا نمی شود می توانید ستون هایی که نمایش آنها ضرورتی ندارد را غیر فعال نمایید.', 'class' => 'fixed-width-lg', ), array( 'type' => 'switch', 'label' => $this->l('CUSTOMER'), 'name' => 'ShowSentSMScustomer', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('ORDER'), 'name' => 'ShowSentSMSorder', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('POSITION'), 'name' => 'ShowSentSMSposition', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('TIME'), 'name' => 'ShowSentSMStime', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('STATUS'), 'name' => 'ShowSentSMSstatus', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('BULK'), 'name' => 'ShowSentSMSbulk', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('SHOP'), 'name' => 'ShowSentSMSshop', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), array( 'type' => 'switch', 'label' => $this->l('Duration'), 'name' => 'ShowSentSMSduration', 'values' => array( array( 'id' => 'active_on', 'value' => 1, 'label' => $this->l('Yes') ), array( 'id' => 'active_off', 'value' => 0, 'label' => $this->l('No') ) ), ), ), 'submit' => array( 'title' => $this->l('Update Settings'), 'name' => 'sentsms', ) ), ); $helper = new HelperForm(); $helper->module = $this; $helper->name_controller = $this->name; $helper->token = Tools::getAdminTokenLite('AdminModules'); $helper->show_toolbar = false; $helper->toolbar_scroll = false; $lang = new Language((int)Configuration::get('PS_LANG_DEFAULT')); $helper->default_form_language = $lang->id; $allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG'); $helper->allow_employee_form_lang = $allow_employee_form_lang ? $allow_employee_form_lang : 0; $this->fields_form = array(); $helper->submit_action = $this->name; $helper->currentIndex = $this->context->link->getAdminLink('AdminModules', false). '&configure='.$this->name.'&tab_module='.$this->tab.'&module_name='.$this->name; $helper->tpl_vars = array( 'fields_value' => $this->getConfigFieldsValues(), 'languages' => $this->context->controller->getLanguages(), 'id_language' => $this->context->language->id ); $output .= '<div id="smsreportsettings" class="tab-pane">'.$helper->generateForm(array($fields_form)).'</div>'; $output .= '</div><!--Tabs Contents-->'; if (version_compare(_PS_VERSION_, '1.7', '>') == true) { $output .= '<script>$("#form-sentsms .panel-heading").html($("#form-sentsms .panel-heading").text());</script>'; } 