<?php
require_once(dirname(__FILE__).'../../../config/config.inc.php'); require_once(dirname(__FILE__).'../../../init.php'); if (substr(Tools::encrypt('ranginesmspresta/cron'), 0, 10) != Tools::getValue('token') || !Module::isInstalled('ranginesmspresta')) die('bad token!'); if (!defined('_PS_VERSION_')) { die('Get Error!'); } $starttime = time(); $output = ''; require_once('ranginesmspresta.php'); $ranginesmspresta = new RangineSmsPresta; $logs = $ranginesmspresta->getLogs($page = 0, $onpage = 'cron', $bulk = null, $phone = null, $customer = null, $order = null, $position = null, $shop_id = null, $status = 'queue'); $ranginesmspresta->cronpass = true; foreach ($logs as $log) { $result = $ranginesmspresta->sendOne($log['description'], $log['phone'], $log['customer'], $log['id_order'], $log['position']); if($result == 'sent'){ Db::getInstance()->delete($ranginesmspresta->name, 'id_ranginesmspresta = '.$log['id_ranginesmspresta'], 1); $output .= 'sent: '.$log['description'].' to: '.$log['phone']."\n"; }else{ $output .= 'Not Sent: '.$log['description'].' to: '.$log['phone']."\n"; } } $ranginesmspresta->debug($output, 'cron'); $endtime = time(); $durationtime = $endtime - $starttime; Configuration::updateValue('RANGINE_SMS_CronLastRunTime' , $starttime); Configuration::updateValue('RANGINE_SMS_CronLastRunDuration' , $durationtime);